// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 테이블 정의 및 관계(Relation) 설정 ---

model RefEquipment {
  eqpid String @id
  sdwt  String
  
  // [수정] RefSdwt와의 관계 설정 (코드에서 'sdwtRel'로 접근)
  sdwtRel     RefSdwt      @relation(fields: [sdwt], references: [sdwt]) 
  
  // 다른 테이블들과의 관계 설정
  agentInfo   AgentInfo?
  agentStatus AgentStatus?
  
  // [수정] 에러 로그와의 1:N 관계 설정 (코드에서 'plgErrors'로 접근 가능)
  plgErrors   PlgError[]   
  
  // [수정] 성능 로그와의 1:N 관계 설정
  eqpPerfs    EqpPerf[]    

  @@map("ref_equipment")
}

model RefSdwt {
  sdwt   String @id
  site   String
  isUse  String @map("is_use") // 'Y' or 'N'

  // RefEquipment와의 역방향 관계
  equipments RefEquipment[]

  @@map("ref_sdwt")
}

model AgentInfo {
  eqpid       String  @id
  pcName      String? @map("pc_name")
  appVer      String? @map("app_ver")
  type        String?
  ipAddress   String? @map("ip_address")
  os          String?
  systemType  String? @map("system_type")
  locale      String?
  timezone    String?
  macAddress  String? @map("mac_address")
  
  // RefEquipment와의 1:1 관계
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("agent_info")
}

model AgentStatus {
  eqpid          String    @id
  status         String?   // 'ONLINE' | 'OFFLINE'
  lastPerfUpdate DateTime? @map("last_perf_update")
  
  // RefEquipment와의 1:1 관계
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("agent_status")
}

model PlgError {
  eqpid     String
  timeStamp DateTime @map("time_stamp")
  errorId   String?  @map("error_id")     // 필요한 필드 추가
  errorLabel String? @map("error_label")  // 필요한 필드 추가
  
  // [수정] RefEquipment와의 N:1 관계 설정 (코드에서 'equipment'로 접근)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, timeStamp])
  @@map("plg_error")
}

model PlgWfFlat {
  eqpid  String
  servTs DateTime @map("serv_ts")
  // 필요한 경우 관계 추가
  
  @@id([eqpid, servTs])
  @@map("plg_wf_flat")
}

model EqpPerf {
  eqpid    String
  servTs   DateTime @map("serv_ts")
  ts       DateTime?
  cpuUsage Float?   @map("cpu_usage")
  memUsage Float?   @map("mem_usage")

  // RefEquipment와의 N:1 관계 설정
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, servTs])
  @@map("eqp_perf")
}

// 프로세스 성능 등 추가 테이블
model EqpProcPerf {
  eqpid         String
  servTs        DateTime @map("serv_ts")
  processName   String   @map("process_name")
  memoryUsageMB Float?   @map("memory_usage_mb")

  @@id([eqpid, servTs, processName])
  @@map("eqp_proc_perf")
}

model ItmInfo {
  eqpid       String @id
  systemModel String? @map("system_model")
  serialNum   String? @map("serial_num")
  application String?
  version     String?
  dbVersion   String? @map("db_version")

  @@map("itm_info")
}
